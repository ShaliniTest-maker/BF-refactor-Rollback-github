{% extends "templates/emails/base/email_base.html" %}

{% block title %}üö® Critical Security Alert - Immediate Action Required{% endblock %}

{% block header_title %}Security Alert System{% endblock %}
{% block header_subtitle %}Critical Security Incident Detected{% endblock %}

{% block additional_styles %}
<style>
    /* Security Alert Specific Styles */
    .security-alert-header {
        background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        color: #ffffff;
        padding: 25px;
        text-align: center;
        border-radius: 8px 8px 0 0;
    }

    .critical-banner {
        background-color: #fef2f2;
        border-left: 6px solid #dc2626;
        padding: 20px;
        margin: 20px 0;
        border-radius: 0 6px 6px 0;
    }

    .critical-banner h2 {
        color: #991b1b;
        margin: 0 0 10px 0;
        font-size: 20px;
        font-weight: 700;
    }

    .alert-severity {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .severity-critical {
        background-color: #dc2626;
        color: #ffffff;
    }

    .severity-high {
        background-color: #ea580c;
        color: #ffffff;
    }

    .severity-medium {
        background-color: #d97706;
        color: #ffffff;
    }

    .severity-warning {
        background-color: #eab308;
        color: #000000;
    }

    .incident-details {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 25px;
        margin: 25px 0;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #e2e8f0;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-weight: 600;
        color: #374151;
        min-width: 150px;
    }

    .detail-value {
        color: #6b7280;
        flex: 1;
        text-align: right;
        font-family: 'Courier New', monospace;
    }

    .security-metrics {
        background-color: #fefce8;
        border: 1px solid #fde047;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .metric-item {
        background-color: #ffffff;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        text-align: center;
    }

    .metric-value {
        font-size: 24px;
        font-weight: 700;
        color: #dc2626;
        display: block;
    }

    .metric-label {
        font-size: 12px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 5px;
    }

    .affected-systems {
        background-color: #fef3f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }

    .system-list {
        list-style: none;
        padding: 0;
        margin: 15px 0 0 0;
    }

    .system-item {
        padding: 10px;
        background-color: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .system-name {
        font-weight: 600;
        color: #374151;
    }

    .system-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-compromised {
        background-color: #fecaca;
        color: #991b1b;
    }

    .status-monitoring {
        background-color: #fed7aa;
        color: #9a3412;
    }

    .status-isolated {
        background-color: #ddd6fe;
        color: #5b21b6;
    }

    .recommended-actions {
        background-color: #f0f9ff;
        border: 1px solid #7dd3fc;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }

    .action-list {
        list-style: none;
        padding: 0;
        margin: 15px 0 0 0;
    }

    .action-item {
        padding: 12px;
        background-color: #ffffff;
        border: 1px solid #e0e7ff;
        border-radius: 4px;
        margin-bottom: 10px;
        position: relative;
        padding-left: 45px;
    }

    .action-item::before {
        content: "‚ö°";
        position: absolute;
        left: 15px;
        top: 12px;
        font-size: 16px;
    }

    .action-priority {
        font-weight: 700;
        color: #1e40af;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 1px;
    }

    .action-description {
        color: #374151;
        margin-top: 5px;
    }

    .timeline-container {
        background-color: #f9fafb;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }

    .timeline-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e5e7eb;
    }

    .timeline-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .timeline-time {
        min-width: 80px;
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        font-family: 'Courier New', monospace;
    }

    .timeline-content {
        flex: 1;
        margin-left: 15px;
    }

    .timeline-title {
        font-weight: 600;
        color: #374151;
        margin: 0 0 5px 0;
    }

    .timeline-description {
        color: #6b7280;
        font-size: 14px;
        margin: 0;
    }

    .contact-emergency {
        background-color: #7f1d1d;
        color: #ffffff;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        margin: 25px 0;
    }

    .emergency-phone {
        font-size: 24px;
        font-weight: 700;
        margin: 10px 0;
        font-family: 'Courier New', monospace;
    }

    .urgency-indicator {
        animation: pulse 2s infinite;
        display: inline-block;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    /* Responsive Design */
    @media only screen and (max-width: 600px) {
        .detail-row {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .detail-value {
            text-align: left;
            margin-top: 5px;
        }
        
        .metrics-grid {
            grid-template-columns: 1fr;
        }
        
        .system-item {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .system-status {
            margin-top: 8px;
            align-self: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Critical Security Alert Banner -->
<div class="critical-banner">
    <h2 class="urgency-indicator">üö® CRITICAL SECURITY INCIDENT DETECTED</h2>
    <p class="mb-0">
        <strong>Incident ID:</strong> {{ incident_id | default('SEC-' + timestamp | replace(':', '') | replace('-', '') | replace(' ', '')) }}<br>
        <strong>Detection Time:</strong> {{ detection_time | default(timestamp) }}<br>
        <strong>Severity Level:</strong> 
        <span class="alert-severity severity-{{ severity | lower | default('critical') }}">
            {{ severity | default('CRITICAL') }}
        </span>
    </p>
</div>

<!-- Incident Summary -->
<div class="content-title">Security Incident Summary</div>
<div class="content-text">
    {% if incident_type %}
    <strong>Incident Type:</strong> {{ incident_type }}<br>
    {% endif %}
    {% if description %}
    <strong>Description:</strong> {{ description }}<br>
    {% endif %}
    {% if affected_component %}
    <strong>Affected Component:</strong> {{ affected_component }}<br>
    {% endif %}
    {% if source_ip %}
    <strong>Source IP:</strong> <code>{{ source_ip }}</code><br>
    {% endif %}
    {% if user_id %}
    <strong>Affected User ID:</strong> <code>{{ user_id }}</code><br>
    {% endif %}
</div>

<!-- Security Incident Details -->
<div class="incident-details">
    <h3 style="margin: 0 0 20px 0; color: #374151;">üìã Detailed Incident Information</h3>
    
    <div class="detail-row">
        <span class="detail-label">üîç Detection Method:</span>
        <span class="detail-value">{{ detection_method | default('Flask Security Monitoring + Auth0 Alerts') }}</span>
    </div>
    
    <div class="detail-row">
        <span class="detail-label">üèóÔ∏è Infrastructure Context:</span>
        <span class="detail-value">
            {% if container_id %}
            Container: {{ container_id }}<br>
            {% endif %}
            {% if ecs_task_arn %}
            ECS Task: {{ ecs_task_arn | truncate(50) }}<br>
            {% endif %}
            {% if gunicorn_worker %}
            WSGI Worker: {{ gunicorn_worker }}<br>
            {% endif %}
            Flask App Instance: {{ app_instance | default('Primary') }}
        </span>
    </div>
    
    <div class="detail-row">
        <span class="detail-label">üîê Authentication Context:</span>
        <span class="detail-value">
            {% if auth_method %}
            Method: {{ auth_method }}<br>
            {% endif %}
            {% if jwt_token_id %}
            JWT Token ID: {{ jwt_token_id | truncate(20) }}...<br>
            {% endif %}
            {% if session_id %}
            Session ID: {{ session_id | truncate(20) }}...<br>
            {% endif %}
            Auth0 Domain: {{ auth0_domain | default('Not Available') }}
        </span>
    </div>
    
    <div class="detail-row">
        <span class="detail-label">üìä Security Metrics:</span>
        <span class="detail-value">
            Failed Attempts: {{ failed_attempts | default('N/A') }}<br>
            Risk Score: {{ risk_score | default('N/A') }}/100<br>
            Confidence: {{ confidence | default('High') }}
        </span>
    </div>
    
    <div class="detail-row">
        <span class="detail-label">üóÑÔ∏è Database Impact:</span>
        <span class="detail-value">
            {% if affected_tables %}
            Tables: {{ affected_tables | join(', ') }}<br>
            {% endif %}
            {% if connection_pool_impact %}
            Pool Impact: {{ connection_pool_impact }}<br>
            {% endif %}
            SQLAlchemy Status: {{ sqlalchemy_status | default('Monitoring') }}
        </span>
    </div>
</div>

<!-- Security Metrics Dashboard -->
<div class="security-metrics">
    <h3 style="margin: 0 0 10px 0; color: #92400e;">üìà Real-Time Security Metrics</h3>
    <p class="mb-0" style="color: #92400e; font-size: 14px;">
        Current security posture and incident impact assessment
    </p>
    
    <div class="metrics-grid">
        <div class="metric-item">
            <span class="metric-value">{{ authentication_failures | default('0') }}</span>
            <div class="metric-label">Auth Failures (5min)</div>
        </div>
        <div class="metric-item">
            <span class="metric-value">{{ authorization_violations | default('0') }}</span>
            <div class="metric-label">Authorization Violations</div>
        </div>
        <div class="metric-item">
            <span class="metric-value">{{ suspicious_activities | default('1') }}</span>
            <div class="metric-label">Suspicious Activities</div>
        </div>
        <div class="metric-item">
            <span class="metric-value">{{ affected_users | default('0') }}</span>
            <div class="metric-label">Affected Users</div>
        </div>
        {% if container_metrics %}
        <div class="metric-item">
            <span class="metric-value">{{ container_metrics.cpu_usage | default('N/A') }}%</span>
            <div class="metric-label">Container CPU</div>
        </div>
        <div class="metric-item">
            <span class="metric-value">{{ container_metrics.memory_usage | default('N/A') }}%</span>
            <div class="metric-label">Container Memory</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Affected Systems -->
<div class="affected-systems">
    <h3 style="margin: 0 0 10px 0; color: #991b1b;">üñ•Ô∏è Affected Systems & Components</h3>
    <p class="mb-0" style="color: #991b1b; font-size: 14px;">
        Systems currently impacted or under investigation
    </p>
    
    <ul class="system-list">
        {% if affected_systems %}
            {% for system in affected_systems %}
            <li class="system-item">
                <span class="system-name">{{ system.name }}</span>
                <span class="system-status status-{{ system.status | lower | default('monitoring') }}">
                    {{ system.status | default('MONITORING') }}
                </span>
            </li>
            {% endfor %}
        {% else %}
        <li class="system-item">
            <span class="system-name">Flask Application (Primary)</span>
            <span class="system-status status-monitoring">MONITORING</span>
        </li>
        <li class="system-item">
            <span class="system-name">Auth0 Integration</span>
            <span class="system-status status-monitoring">MONITORING</span>
        </li>
        <li class="system-item">
            <span class="system-name">PostgreSQL Database</span>
            <span class="system-status status-monitoring">MONITORING</span>
        </li>
        {% if container_id %}
        <li class="system-item">
            <span class="system-name">Container {{ container_id | truncate(12) }}</span>
            <span class="system-status status-monitoring">MONITORING</span>
        </li>
        {% endif %}
        {% endif %}
    </ul>
</div>

<!-- Recommended Actions -->
<div class="recommended-actions">
    <h3 style="margin: 0 0 10px 0; color: #1e40af;">‚ö° Immediate Actions Required</h3>
    <p class="mb-0" style="color: #1e40af; font-size: 14px;">
        Critical actions to contain and investigate this security incident
    </p>
    
    <ul class="action-list">
        {% if recommended_actions %}
            {% for action in recommended_actions %}
            <li class="action-item">
                <div class="action-priority">{{ action.priority | default('HIGH') }} PRIORITY</div>
                <div class="action-description">{{ action.description }}</div>
            </li>
            {% endfor %}
        {% else %}
        <li class="action-item">
            <div class="action-priority">IMMEDIATE</div>
            <div class="action-description">
                Verify and isolate affected user accounts in Auth0 dashboard
            </div>
        </li>
        <li class="action-item">
            <div class="action-priority">IMMEDIATE</div>
            <div class="action-description">
                Review Flask application logs for {{ detection_time | default('current timeframe') }}
            </div>
        </li>
        <li class="action-item">
            <div class="action-priority">HIGH</div>
            <div class="action-description">
                Validate SQLAlchemy connection pool health and active sessions
            </div>
        </li>
        <li class="action-item">
            <div class="action-priority">HIGH</div>
            <div class="action-description">
                Check Gunicorn worker processes and container resource utilization
            </div>
        </li>
        <li class="action-item">
            <div class="action-priority">MEDIUM</div>
            <div class="action-description">
                Review AWS CloudWatch security alarms and container metrics
            </div>
        </li>
        {% endif %}
    </ul>
</div>

<!-- Incident Timeline -->
{% if timeline %}
<div class="timeline-container">
    <h3 style="margin: 0 0 15px 0; color: #374151;">‚è±Ô∏è Incident Timeline</h3>
    
    {% for event in timeline %}
    <div class="timeline-item">
        <div class="timeline-time">{{ event.time }}</div>
        <div class="timeline-content">
            <h4 class="timeline-title">{{ event.title }}</h4>
            <p class="timeline-description">{{ event.description }}</p>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Emergency Contact Information -->
<div class="contact-emergency">
    <h3 style="margin: 0 0 10px 0;">üìû Emergency Security Response</h3>
    <p style="margin: 0 0 10px 0; opacity: 0.9;">
        For immediate assistance with this security incident:
    </p>
    <div class="emergency-phone">
        {{ emergency_phone | default('+1-XXX-XXX-XXXX') }}
    </div>
    <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.8;">
        Security Team Escalation ‚Ä¢ Available 24/7
    </p>
</div>

<!-- Action Buttons -->
<div class="button-container">
    {% if incident_response_url %}
    <a href="{{ incident_response_url }}" class="button">
        üîç Access Incident Response Dashboard
    </a>
    {% endif %}
    {% if monitoring_dashboard_url %}
    <a href="{{ monitoring_dashboard_url }}" class="button button-secondary">
        üìä View Security Monitoring Dashboard
    </a>
    {% endif %}
</div>

<!-- Additional Context Information -->
<div class="security-info">
    <h4 class="security-title">
        <span class="security-icon">üõ°Ô∏è</span>
        Security Context & Additional Information
    </h4>
    <div class="security-text">
        <strong>Monitoring System:</strong> Flask Security Framework + Auth0 Integration<br>
        <strong>Detection Capabilities:</strong> Real-time authentication monitoring, SQLAlchemy security events, container security metrics<br>
        <strong>Architecture:</strong> 
        {% if container_id %}
        Containerized Flask Application ({{ container_id | truncate(12) }})
        {% else %}
        Flask Application with Gunicorn WSGI Server
        {% endif %}
        <br>
        <strong>Database Security:</strong> PostgreSQL with Flask-SQLAlchemy connection pool monitoring<br>
        <strong>Service Layer:</strong> Security incident coordination through Service Layer patterns<br>
        {% if additional_context %}
        <strong>Additional Context:</strong> {{ additional_context }}
        {% endif %}
    </div>
</div>

<!-- Footer Warning -->
<div class="alert alert-warning">
    <strong>‚ö†Ô∏è Critical Security Notice:</strong> This security alert was automatically generated by the Flask 
    Security Monitoring System. The incident requires immediate administrative attention to ensure system 
    integrity and user data protection. Please respond within 15 minutes of receiving this alert.
    {% if auto_isolation_enabled %}
    <br><br>
    <strong>üîí Automatic Isolation:</strong> Affected components have been automatically isolated pending 
    administrative review. Normal service operations continue for unaffected systems.
    {% endif %}
</div>
{% endblock %}