{% extends "emails/base/email_base.html" if email_base_exists else None %}

{#
Administrative User Status Change Notification Template
Flask 3.1.1 + Jinja2 3.1.2+ Implementation
Integrates with Service Layer pattern and Auth0 user profile management
Supports comprehensive user account status changes and administrative workflows
#}

{% if not email_base_exists %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Status Change Notification</title>
    <style>
        /* Inline CSS for email client compatibility */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6; 
            color: #333; 
            margin: 0; 
            padding: 20px; 
            background-color: #f5f5f5; 
        }
        .email-container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px 20px; 
            text-align: center; 
        }
        .content { 
            padding: 30px 20px; 
        }
        .status-badge { 
            display: inline-block; 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-weight: bold; 
            font-size: 14px; 
            text-transform: uppercase; 
            margin: 10px 0; 
        }
        .status-active { background-color: #d4edda; color: #155724; }
        .status-suspended { background-color: #f8d7da; color: #721c24; }
        .status-deactivated { background-color: #ffeaa7; color: #6c5300; }
        .status-role-changed { background-color: #d1ecf1; color: #0c5460; }
        .user-details { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 8px; 
            margin: 20px 0; 
            border-left: 4px solid #667eea; 
        }
        .admin-info { 
            background: #fff3cd; 
            padding: 15px; 
            border-radius: 6px; 
            margin: 15px 0; 
            border: 1px solid #ffeaa7; 
        }
        .action-required { 
            background: #f8d7da; 
            padding: 15px; 
            border-radius: 6px; 
            margin: 20px 0; 
            border-left: 4px solid #dc3545; 
        }
        .next-actions { 
            background: #d4edda; 
            padding: 15px; 
            border-radius: 6px; 
            margin: 20px 0; 
            border-left: 4px solid #28a745; 
        }
        .footer { 
            background: #343a40; 
            color: #adb5bd; 
            padding: 20px; 
            text-align: center; 
            font-size: 12px; 
        }
        .timestamp { 
            color: #6c757d; 
            font-size: 14px; 
            font-style: italic; 
        }
        .security-notice { 
            background: #fff3cd; 
            border: 1px solid #ffeaa7; 
            padding: 15px; 
            border-radius: 6px; 
            margin: 20px 0; 
        }
        .auth0-profile { 
            background: #e3f2fd; 
            padding: 15px; 
            border-radius: 6px; 
            margin: 15px 0; 
            border-left: 4px solid #2196f3; 
        }
        @media only screen and (max-width: 600px) {
            .email-container { margin: 10px; }
            .header, .content { padding: 20px 15px; }
        }
    </style>
</head>
<body>
    <div class="email-container">
{% endif %}

{% if email_base_exists %}
{% block title %}User Status Change Notification{% endblock %}

{% block content %}
{% else %}
        <div class="header">
            <h1>üîê User Status Change Notification</h1>
            <p>Administrative Alert - User Account Management</p>
        </div>
        
        <div class="content">
{% endif %}

{# Main notification content with Service Layer integration #}
            <h2>User Account Status Update</h2>
            
            {# Dynamic status badge based on change type #}
            {% set status_class = 'status-' + (change_type | replace('_', '-') | lower) %}
            <div class="status-badge {{ status_class }}">
                {{ change_type | replace('_', ' ') | title }}
            </div>
            
            <p>This notification was generated by the Flask Service Layer administrative workflow system to inform you of a user account status change that requires administrative attention.</p>
            
            {# User profile information with Auth0 integration #}
            <div class="user-details">
                <h3>üë§ User Information</h3>
                <p><strong>User ID:</strong> {{ user.id }}</p>
                <p><strong>Username:</strong> {{ user.username }}</p>
                <p><strong>Email:</strong> {{ user.email }}</p>
                {% if user.full_name %}
                <p><strong>Full Name:</strong> {{ user.full_name }}</p>
                {% endif %}
                
                {# Auth0 user profile integration data #}
                {% if auth0_profile %}
                <div class="auth0-profile">
                    <h4>üîó Auth0 Profile Information</h4>
                    <p><strong>Auth0 User ID:</strong> {{ auth0_profile.user_id }}</p>
                    <p><strong>Connection:</strong> {{ auth0_profile.connection | default('Unknown') }}</p>
                    <p><strong>Provider:</strong> {{ auth0_profile.provider | default('auth0') }}</p>
                    {% if auth0_profile.last_login %}
                    <p><strong>Last Login:</strong> {{ auth0_profile.last_login.strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
                    {% endif %}
                    {% if auth0_profile.login_count %}
                    <p><strong>Login Count:</strong> {{ auth0_profile.login_count }}</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            {# Status change details with comprehensive information #}
            <div class="user-details">
                <h3>üìã Change Details</h3>
                <p><strong>Change Type:</strong> {{ change_type | replace('_', ' ') | title }}</p>
                <p><strong>Previous Status:</strong> {{ previous_status | default('Active') }}</p>
                <p><strong>New Status:</strong> {{ new_status }}</p>
                <p><strong>Timestamp:</strong> <span class="timestamp">{{ timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') }}</span></p>
                
                {% if reason %}
                <p><strong>Reason:</strong> {{ reason }}</p>
                {% endif %}
                
                {% if change_details %}
                <h4>Additional Details:</h4>
                <ul>
                    {% for detail_key, detail_value in change_details.items() %}
                    <li><strong>{{ detail_key | replace('_', ' ') | title }}:</strong> {{ detail_value }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            
            {# Role-based access control (RBAC) changes section #}
            {% if change_type in ['role_changed', 'permissions_modified', 'access_level_updated'] %}
            <div class="user-details">
                <h3>üõ°Ô∏è RBAC Changes</h3>
                {% if role_changes %}
                <h4>Role Modifications:</h4>
                <ul>
                    {% for role_change in role_changes %}
                    <li>
                        <strong>{{ role_change.action | title }}:</strong> {{ role_change.role_name }}
                        {% if role_change.effective_date %}
                        (Effective: {{ role_change.effective_date.strftime('%Y-%m-%d') }})
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
                
                {% if permission_changes %}
                <h4>Permission Updates:</h4>
                <ul>
                    {% for perm_change in permission_changes %}
                    <li>
                        <strong>{{ perm_change.action | title }}:</strong> {{ perm_change.permission }}
                        {% if perm_change.resource %}
                        on {{ perm_change.resource }}
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            {% endif %}
            
            {# Administrative user information #}
            <div class="admin-info">
                <h3>üë®‚Äçüíº Administrative Action</h3>
                <p><strong>Admin User:</strong> {{ admin_user.username }} ({{ admin_user.email }})</p>
                <p><strong>Admin ID:</strong> {{ admin_user.id }}</p>
                {% if admin_user.full_name %}
                <p><strong>Admin Name:</strong> {{ admin_user.full_name }}</p>
                {% endif %}
                <p><strong>Action Timestamp:</strong> <span class="timestamp">{{ timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') }}</span></p>
                
                {% if admin_notes %}
                <p><strong>Admin Notes:</strong></p>
                <p style="font-style: italic; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 4px;">{{ admin_notes }}</p>
                {% endif %}
            </div>
            
            {# Security monitoring and incident tracking #}
            {% if security_context %}
            <div class="security-notice">
                <h3>üö® Security Monitoring Alert</h3>
                <p><strong>Risk Level:</strong> {{ security_context.risk_level | default('Medium') }}</p>
                {% if security_context.incident_id %}
                <p><strong>Incident ID:</strong> {{ security_context.incident_id }}</p>
                {% endif %}
                {% if security_context.suspicious_activity %}
                <p><strong>Suspicious Activity Detected:</strong> {{ security_context.suspicious_activity }}</p>
                {% endif %}
                {% if security_context.ip_address %}
                <p><strong>Source IP:</strong> {{ security_context.ip_address }}</p>
                {% endif %}
                {% if security_context.user_agent %}
                <p><strong>User Agent:</strong> {{ security_context.user_agent }}</p>
                {% endif %}
            </div>
            {% endif %}
            
            {# Approval workflow section for administrative oversight #}
            {% if approval_required %}
            <div class="action-required">
                <h3>‚ö†Ô∏è Administrative Approval Required</h3>
                <p>This status change requires administrative review and approval before taking effect.</p>
                
                {% if approval_workflow %}
                <h4>Approval Workflow:</h4>
                <ul>
                    {% for step in approval_workflow %}
                    <li>
                        <strong>Step {{ loop.index }}:</strong> {{ step.description }}
                        {% if step.assigned_to %}
                        (Assigned to: {{ step.assigned_to }})
                        {% endif %}
                        {% if step.deadline %}
                        (Deadline: {{ step.deadline.strftime('%Y-%m-%d') }})
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
                
                {% if approval_url %}
                <p><strong>Action Required:</strong> <a href="{{ approval_url }}" target="_blank" style="color: #dc3545; font-weight: bold;">Review and Approve</a></p>
                {% endif %}
            </div>
            {% endif %}
            
            {# Next actions and recommendations #}
            <div class="next-actions">
                <h3>üìã Recommended Next Actions</h3>
                
                {% if next_actions %}
                <ul>
                    {% for action in next_actions %}
                    <li>
                        <strong>{{ action.priority | default('Normal') | title }} Priority:</strong> {{ action.description }}
                        {% if action.deadline %}
                        (By: {{ action.deadline.strftime('%Y-%m-%d') }})
                        {% endif %}
                        {% if action.assigned_to %}
                        - Assigned to: {{ action.assigned_to }}
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                {# Default recommendations based on change type #}
                {% if change_type == 'account_suspended' %}
                <ul>
                    <li><strong>High Priority:</strong> Review security logs for suspicious activity</li>
                    <li><strong>Medium Priority:</strong> Contact user to verify account security</li>
                    <li><strong>Normal Priority:</strong> Document incident in security system</li>
                </ul>
                {% elif change_type == 'role_changed' %}
                <ul>
                    <li><strong>High Priority:</strong> Verify user understands new permissions</li>
                    <li><strong>Medium Priority:</strong> Update access documentation</li>
                    <li><strong>Normal Priority:</strong> Schedule role effectiveness review</li>
                </ul>
                {% elif change_type == 'account_activated' %}
                <ul>
                    <li><strong>Medium Priority:</strong> Send welcome communication to user</li>
                    <li><strong>Normal Priority:</strong> Verify onboarding checklist completion</li>
                    <li><strong>Normal Priority:</strong> Schedule first login follow-up</li>
                </ul>
                {% elif change_type == 'account_deactivated' %}
                <ul>
                    <li><strong>High Priority:</strong> Verify data access revocation</li>
                    <li><strong>Medium Priority:</strong> Update team access documentation</li>
                    <li><strong>Normal Priority:</strong> Archive user data per retention policy</li>
                </ul>
                {% else %}
                <ul>
                    <li><strong>Medium Priority:</strong> Verify change was applied correctly</li>
                    <li><strong>Normal Priority:</strong> Update user documentation</li>
                    <li><strong>Normal Priority:</strong> Monitor for any access issues</li>
                </ul>
                {% endif %}
                {% endif %}
            </div>
            
            {# Service Layer pattern integration information #}
            {% if service_context %}
            <div class="user-details">
                <h3>‚öôÔ∏è Service Layer Information</h3>
                <p><strong>Workflow ID:</strong> {{ service_context.workflow_id }}</p>
                <p><strong>Service:</strong> {{ service_context.service_name | default('UserManagementService') }}</p>
                {% if service_context.transaction_id %}
                <p><strong>Transaction ID:</strong> {{ service_context.transaction_id }}</p>
                {% endif %}
                {% if service_context.validation_status %}
                <p><strong>Validation Status:</strong> {{ service_context.validation_status }}</p>
                {% endif %}
                {% if service_context.rollback_available %}
                <p><strong>Rollback Available:</strong> {{ 'Yes' if service_context.rollback_available else 'No' }}</p>
                {% endif %}
            </div>
            {% endif %}
            
            {# System monitoring and links #}
            <div class="user-details">
                <h3>üîó Administrative Links</h3>
                {% if admin_panel_url %}
                <p><a href="{{ admin_panel_url }}/users/{{ user.id }}" target="_blank" style="color: #667eea; text-decoration: none;">üìä View User Dashboard</a></p>
                {% endif %}
                {% if security_logs_url %}
                <p><a href="{{ security_logs_url }}?user_id={{ user.id }}" target="_blank" style="color: #667eea; text-decoration: none;">üîç Security Activity Logs</a></p>
                {% endif %}
                {% if audit_trail_url %}
                <p><a href="{{ audit_trail_url }}?user_id={{ user.id }}" target="_blank" style="color: #667eea; text-decoration: none;">üìã Audit Trail</a></p>
                {% endif %}
                {% if auth0_dashboard_url %}
                <p><a href="{{ auth0_dashboard_url }}" target="_blank" style="color: #667eea; text-decoration: none;">üîó Auth0 User Management</a></p>
                {% endif %}
            </div>
            
            {# Important security and compliance notice #}
            <div class="security-notice">
                <h3>üõ°Ô∏è Security Notice</h3>
                <p><strong>Confidential Information:</strong> This notification contains sensitive user account information and should be handled according to your organization's data protection policies.</p>
                <p><strong>Retention:</strong> This notification is automatically logged in the Flask application audit system with timestamp {{ timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') }}.</p>
                <p><strong>Support:</strong> For questions about this notification or the user status change, contact the system administrator or security team.</p>
            </div>

{% if not email_base_exists %}
        </div>
        
        <div class="footer">
            <p>üè¢ Administrative User Management System</p>
            <p>Flask 3.1.1 Application ‚Ä¢ Service Layer Pattern</p>
            <p>Generated at {{ timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
            <p style="margin-top: 15px; font-size: 11px;">
                This is an automated notification from the Flask administrative system.<br>
                Please do not reply to this email. For support, contact your system administrator.
            </p>
        </div>
    </div>
</body>
</html>
{% else %}
{% endblock %}
{% endif %}

{#
Template Usage Example:
{{ render_template('emails/admin/user_status_changed.html',
    user=user_object,
    auth0_profile=auth0_data,
    change_type='account_suspended',
    previous_status='Active',
    new_status='Suspended',
    timestamp=datetime.utcnow(),
    admin_user=admin_object,
    reason='Security policy violation',
    change_details={'violation_type': 'Unauthorized access attempt', 'attempts': 5},
    security_context={'risk_level': 'High', 'incident_id': 'INC-2024-001'},
    approval_required=True,
    approval_workflow=[
        {'description': 'Security team review', 'assigned_to': 'security@company.com'},
        {'description': 'Management approval', 'assigned_to': 'manager@company.com'}
    ],
    next_actions=[
        {'priority': 'High', 'description': 'Review security logs', 'deadline': datetime.now() + timedelta(days=1)},
        {'priority': 'Medium', 'description': 'Contact user', 'assigned_to': 'support@company.com'}
    ],
    service_context={'workflow_id': 'WF-2024-001', 'service_name': 'UserManagementService'},
    admin_panel_url='https://admin.company.com',
    security_logs_url='https://security.company.com/logs',
    email_base_exists=False
) }}
#}