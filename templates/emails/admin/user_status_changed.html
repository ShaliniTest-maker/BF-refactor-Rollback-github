{% extends "templates/emails/base/email_base.html" %}

{% block title %}User Account Status Changed - Administrative Notification{% endblock %}

{% block header_title %}User Account Management{% endblock %}
{% block header_subtitle %}Administrative Status Change Notification{% endblock %}

{% block additional_styles %}
<style>
    /* Administrative email specific styles */
    .admin-header {
        background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
        color: #ffffff;
    }

    .status-change-container {
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 25px;
        margin: 30px 0;
    }

    .status-change-header {
        font-size: 20px;
        font-weight: 600;
        color: #495057;
        margin: 0 0 20px 0;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .status-icon {
        width: 24px;
        height: 24px;
        margin-right: 10px;
        fill: currentColor;
    }

    .user-details {
        background-color: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 20px;
        margin: 20px 0;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f1f3f4;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-weight: 600;
        color: #495057;
        min-width: 140px;
    }

    .detail-value {
        color: #6c757d;
        text-align: right;
        flex: 1;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-active {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-inactive {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .status-suspended {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .status-pending {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    .change-summary {
        background-color: #e7f3ff;
        border-left: 4px solid #007bff;
        padding: 20px;
        margin: 25px 0;
    }

    .change-summary-title {
        font-size: 16px;
        font-weight: 600;
        color: #004085;
        margin: 0 0 10px 0;
    }

    .change-summary-text {
        font-size: 14px;
        color: #004085;
        line-height: 1.5;
        margin: 0;
    }

    .auth0-integration {
        background-color: #f0f0f0;
        border: 1px solid #cccccc;
        border-radius: 6px;
        padding: 15px;
        margin: 20px 0;
    }

    .auth0-title {
        font-size: 14px;
        font-weight: 600;
        color: #333333;
        margin: 0 0 8px 0;
    }

    .auth0-details {
        font-size: 13px;
        color: #666666;
        margin: 0;
    }

    .rbac-changes {
        background-color: #fff8e1;
        border: 1px solid #ffcc02;
        border-radius: 6px;
        padding: 20px;
        margin: 25px 0;
    }

    .rbac-title {
        font-size: 16px;
        font-weight: 600;
        color: #f57c00;
        margin: 0 0 15px 0;
    }

    .role-change {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #ffe082;
    }

    .role-change:last-child {
        border-bottom: none;
    }

    .role-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .role-added {
        background-color: #c8e6c9;
        color: #2e7d2e;
    }

    .role-removed {
        background-color: #ffcdd2;
        color: #c62828;
    }

    .role-modified {
        background-color: #e1bee7;
        color: #6a1b9a;
    }

    .next-actions {
        background-color: #e8f5e8;
        border: 1px solid #4caf50;
        border-radius: 6px;
        padding: 20px;
        margin: 25px 0;
    }

    .next-actions-title {
        font-size: 16px;
        font-weight: 600;
        color: #2e7d2e;
        margin: 0 0 15px 0;
    }

    .action-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .action-item {
        padding: 8px 0;
        font-size: 14px;
        color: #2e7d2e;
        position: relative;
        padding-left: 20px;
    }

    .action-item:before {
        content: "â†’";
        position: absolute;
        left: 0;
        font-weight: bold;
    }

    .admin-signature {
        background-color: #f8f9fa;
        border-top: 2px solid #dee2e6;
        padding: 20px;
        margin: 30px 0 0 0;
        text-align: center;
    }

    .admin-signature-title {
        font-size: 14px;
        font-weight: 600;
        color: #495057;
        margin: 0 0 10px 0;
    }

    .admin-signature-text {
        font-size: 13px;
        color: #6c757d;
        margin: 0;
    }

    .security-alert {
        background-color: #fff5f5;
        border: 1px solid #feb2b2;
        border-radius: 6px;
        padding: 15px;
        margin: 20px 0;
    }

    .security-alert-title {
        font-size: 14px;
        font-weight: 600;
        color: #c53030;
        margin: 0 0 8px 0;
    }

    .security-alert-text {
        font-size: 13px;
        color: #c53030;
        margin: 0;
    }

    /* Mobile responsive adjustments */
    @media only screen and (max-width: 600px) {
        .detail-row {
            flex-direction: column;
            align-items: flex-start;
        }

        .detail-label {
            margin-bottom: 5px;
            min-width: auto;
        }

        .detail-value {
            text-align: left;
        }

        .role-change {
            flex-direction: column;
            align-items: flex-start;
        }

        .status-change-header {
            flex-direction: column;
            text-align: center;
        }

        .status-icon {
            margin-right: 0;
            margin-bottom: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Status Change Header -->
<div class="status-change-container">
    <div class="status-change-header">
        <svg class="status-icon" viewBox="0 0 24 24">
            <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1L13.5 2.5L14.17 3.17L9.83 7.51C9.23 8.11 9.23 9.05 9.83 9.65L10.93 10.75L5 16.68V19C5 20.1 5.9 21 7 21H9.32L15.25 15.07L16.35 16.17C16.95 16.77 17.89 16.77 18.49 16.17L22.83 11.83L23.5 12.5L22 14L24 16V14L21 9Z"/>
        </svg>
        User Account Status Change
    </div>

    <!-- Change Summary -->
    <div class="change-summary">
        <div class="change-summary-title">Change Summary</div>
        <div class="change-summary-text">
            {% if change_type == 'activation' %}
                User account has been <strong>activated</strong> and granted access to the system.
            {% elif change_type == 'deactivation' %}
                User account has been <strong>deactivated</strong> and access has been revoked.
            {% elif change_type == 'suspension' %}
                User account has been <strong>suspended</strong> due to security or policy reasons.
            {% elif change_type == 'role_modification' %}
                User account roles and permissions have been <strong>modified</strong>.
            {% elif change_type == 'profile_update' %}
                User account profile information has been <strong>updated</strong> through administrative action.
            {% else %}
                User account status has been <strong>changed</strong> through administrative action.
            {% endif %}
        </div>
    </div>
</div>

<!-- User Details Section -->
<div class="user-details">
    <h3 style="margin: 0 0 20px 0; color: #495057; font-size: 18px;">User Account Information</h3>
    
    <div class="detail-row">
        <span class="detail-label">User ID:</span>
        <span class="detail-value">{{ user_data.user_id if user_data.user_id else 'N/A' }}</span>
    </div>
    
    <div class="detail-row">
        <span class="detail-label">Username:</span>
        <span class="detail-value">{{ user_data.username if user_data.username else 'N/A' }}</span>
    </div>
    
    <div class="detail-row">
        <span class="detail-label">Email:</span>
        <span class="detail-value">{{ user_data.email if user_data.email else 'N/A' }}</span>
    </div>
    
    <div class="detail-row">
        <span class="detail-label">Full Name:</span>
        <span class="detail-value">{{ user_data.full_name if user_data.full_name else 'N/A' }}</span>
    </div>
    
    <div class="detail-row">
        <span class="detail-label">Previous Status:</span>
        <span class="detail-value">
            {% if previous_status %}
                <span class="status-badge status-{{ previous_status|lower }}">{{ previous_status|title }}</span>
            {% else %}
                N/A
            {% endif %}
        </span>
    </div>
    
    <div class="detail-row">
        <span class="detail-label">Current Status:</span>
        <span class="detail-value">
            {% if current_status %}
                <span class="status-badge status-{{ current_status|lower }}">{{ current_status|title }}</span>
            {% else %}
                N/A
            {% endif %}
        </span>
    </div>
    
    <div class="detail-row">
        <span class="detail-label">Change Timestamp:</span>
        <span class="detail-value">{{ change_timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') if change_timestamp else 'N/A' }}</span>
    </div>
    
    <div class="detail-row">
        <span class="detail-label">Performed By:</span>
        <span class="detail-value">{{ admin_user.username if admin_user and admin_user.username else 'System Administrator' }}</span>
    </div>
</div>

<!-- Auth0 Integration Details -->
{% if auth0_profile %}
<div class="auth0-integration">
    <div class="auth0-title">Auth0 Identity Provider Integration</div>
    <div class="auth0-details">
        <strong>Auth0 User ID:</strong> {{ auth0_profile.user_id if auth0_profile.user_id else 'N/A' }}<br>
        <strong>Identity Provider:</strong> {{ auth0_profile.provider if auth0_profile.provider else 'Auth0' }}<br>
        <strong>Last Login:</strong> {{ auth0_profile.last_login.strftime('%Y-%m-%d %H:%M:%S UTC') if auth0_profile.last_login else 'Never' }}<br>
        <strong>Profile Updated:</strong> {{ auth0_profile.updated_at.strftime('%Y-%m-%d %H:%M:%S UTC') if auth0_profile.updated_at else 'N/A' }}
    </div>
</div>
{% endif %}

<!-- RBAC Changes Section -->
{% if role_changes %}
<div class="rbac-changes">
    <div class="rbac-title">Role-Based Access Control (RBAC) Changes</div>
    
    {% for role_change in role_changes %}
    <div class="role-change">
        <span style="flex: 1;">
            <strong>{{ role_change.role_name }}</strong>
            {% if role_change.description %}
                <br><small style="color: #666;">{{ role_change.description }}</small>
            {% endif %}
        </span>
        <span class="role-badge role-{{ role_change.change_type }}">
            {% if role_change.change_type == 'added' %}
                Role Added
            {% elif role_change.change_type == 'removed' %}
                Role Removed
            {% elif role_change.change_type == 'modified' %}
                Permissions Modified
            {% else %}
                {{ role_change.change_type|title }}
            {% endif %}
        </span>
    </div>
    {% endfor %}
    
    {% if approval_required %}
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ffe082;">
        <small style="color: #f57c00;">
            <strong>Note:</strong> Some role changes may require additional approval before taking effect.
        </small>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Security Alert -->
{% if security_impact %}
<div class="security-alert">
    <div class="security-alert-title">Security Impact Assessment</div>
    <div class="security-alert-text">
        {% if security_impact == 'high' %}
            This change has <strong>high security impact</strong>. Additional monitoring and verification procedures are recommended.
        {% elif security_impact == 'medium' %}
            This change has <strong>medium security impact</strong>. Standard monitoring procedures apply.
        {% elif security_impact == 'low' %}
            This change has <strong>low security impact</strong>. Routine monitoring is sufficient.
        {% else %}
            Security impact: {{ security_impact|title }}
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Service Layer Coordination Information -->
{% if service_layer_info %}
<div class="alert alert-info">
    <strong>Service Layer Integration:</strong> This change has been coordinated through the Service Layer pattern to ensure consistency across all functional modules. Related services have been notified and updated accordingly.
    {% if service_layer_info.workflow_id %}
        <br><small><strong>Workflow ID:</strong> {{ service_layer_info.workflow_id }}</small>
    {% endif %}
</div>
{% endif %}

<!-- Change Reason -->
{% if change_reason %}
<div class="alert alert-warning">
    <strong>Reason for Change:</strong> {{ change_reason }}
</div>
{% endif %}

<!-- Next Actions Section -->
<div class="next-actions">
    <div class="next-actions-title">Recommended Next Actions</div>
    
    <ul class="action-list">
        {% if change_type == 'activation' %}
            <li class="action-item">Verify user access to appropriate systems and resources</li>
            <li class="action-item">Monitor initial user activity for the first 24 hours</li>
            <li class="action-item">Ensure user receives welcome communication and training materials</li>
            {% if role_changes %}
                <li class="action-item">Confirm role-based permissions are correctly applied</li>
            {% endif %}
        {% elif change_type == 'deactivation' %}
            <li class="action-item">Verify all system access has been properly revoked</li>
            <li class="action-item">Review and secure any shared resources or documents</li>
            <li class="action-item">Archive user data according to retention policies</li>
            <li class="action-item">Update team assignments and redistribute responsibilities if needed</li>
        {% elif change_type == 'suspension' %}
            <li class="action-item">Monitor for any unauthorized access attempts</li>
            <li class="action-item">Review security logs for the period leading up to suspension</li>
            <li class="action-item">Document investigation findings and next steps</li>
            <li class="action-item">Set review date for potential account reactivation</li>
        {% elif change_type == 'role_modification' %}
            <li class="action-item">Test user access with new role permissions</li>
            <li class="action-item">Verify previous permissions have been properly removed</li>
            <li class="action-item">Update user training records if additional training is required</li>
            <li class="action-item">Monitor user activity with new permissions for 48 hours</li>
        {% else %}
            <li class="action-item">Review change impact on user workflow and system access</li>
            <li class="action-item">Monitor user activity for any issues or access problems</li>
            <li class="action-item">Update relevant documentation and audit trails</li>
        {% endif %}
        
        <!-- Common actions for all change types -->
        <li class="action-item">Update internal user management documentation</li>
        <li class="action-item">Verify compliance with security and audit requirements</li>
        
        {% if next_review_date %}
            <li class="action-item">Schedule follow-up review for {{ next_review_date.strftime('%Y-%m-%d') }}</li>
        {% endif %}
    </ul>
</div>

<!-- Administrative Approval Workflow -->
{% if approval_workflow %}
<div class="alert alert-info">
    <strong>Approval Workflow Status:</strong>
    {% if approval_workflow.status == 'pending' %}
        This change is <strong>pending approval</strong> from {{ approval_workflow.approver_name if approval_workflow.approver_name else 'designated approver' }}.
        {% if approval_workflow.deadline %}
            <br><small>Approval deadline: {{ approval_workflow.deadline.strftime('%Y-%m-%d %H:%M UTC') }}</small>
        {% endif %}
    {% elif approval_workflow.status == 'approved' %}
        This change has been <strong>approved</strong> by {{ approval_workflow.approver_name if approval_workflow.approver_name else 'authorized approver' }}.
        {% if approval_workflow.approved_at %}
            <br><small>Approved on: {{ approval_workflow.approved_at.strftime('%Y-%m-%d %H:%M UTC') }}</small>
        {% endif %}
    {% elif approval_workflow.status == 'rejected' %}
        This change has been <strong>rejected</strong> by {{ approval_workflow.approver_name if approval_workflow.approver_name else 'authorized approver' }}.
        {% if approval_workflow.rejection_reason %}
            <br><small>Reason: {{ approval_workflow.rejection_reason }}</small>
        {% endif %}
    {% endif %}
</div>
{% endif %}

<!-- Additional Notes -->
{% if additional_notes %}
<div class="alert alert-info">
    <strong>Additional Notes:</strong> {{ additional_notes }}
</div>
{% endif %}

<!-- Administrative Signature -->
<div class="admin-signature">
    <div class="admin-signature-title">Administrative Action Record</div>
    <div class="admin-signature-text">
        This notification was generated automatically by the Flask User Management System.<br>
        Change performed by: {{ admin_user.full_name if admin_user and admin_user.full_name else admin_user.username if admin_user and admin_user.username else 'System Administrator' }}<br>
        Action recorded at: {{ change_timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') if change_timestamp else 'N/A' }}<br>
        {% if change_reference_id %}
            Reference ID: {{ change_reference_id }}
        {% endif %}
    </div>
</div>
{% endblock %}

{% block footer %}
<p class="footer-text">
    This is an automated administrative notification from the Flask User Management System.
    This email contains sensitive user account information and should be handled according to your organization's data protection policies.
</p>

<div class="footer-links">
    <a href="#" class="footer-link">User Management Dashboard</a>
    <a href="#" class="footer-link">Security Policies</a>
    <a href="#" class="footer-link">Administrator Support</a>
    <a href="#" class="footer-link">Audit Logs</a>
</div>

<p class="footer-copyright">
    Â© {{ current_year if current_year else 2024 }} Flask User Management System. All rights reserved.<br>
    <small style="color: #adb5bd;">This system implements Auth0 integration and Service Layer architecture patterns for secure user management.</small>
</p>
{% endblock %}