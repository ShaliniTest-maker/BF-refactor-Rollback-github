{% extends "templates/emails/base/base.html" %}

{% block title %}Infrastructure Alert - {{ alert_type }} - {{ severity|upper }}{% endblock %}

{% block email_label %}Infrastructure monitoring alert for {{ alert_type }}{% endblock %}

{% block header_title %}Infrastructure Alert{% endblock %}

{% block email_styles %}
/* Infrastructure Alert Specific Styles */
.alert-container {
    margin: 0 0 20px 0;
    border-radius: 8px;
    border-left: 6px solid;
    padding: 20px;
    background-color: #f8f9fa;
}

.alert-critical {
    border-left-color: #dc3545;
    background-color: #f8d7da;
    color: #721c24;
}

.alert-high {
    border-left-color: #fd7e14;
    background-color: #fdeaa7;
    color: #664d03;
}

.alert-medium {
    border-left-color: #ffc107;
    background-color: #fff3cd;
    color: #664d03;
}

.alert-low {
    border-left-color: #28a745;
    background-color: #d4edda;
    color: #155724;
}

.alert-header {
    margin: 0 0 16px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
}

.alert-severity {
    font-weight: 700;
    font-size: 18px;
    text-transform: uppercase;
    margin: 0;
}

.alert-timestamp {
    font-size: 14px;
    opacity: 0.8;
    margin: 0;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.metrics-card {
    background-color: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.metrics-card h3 {
    margin: 0 0 16px 0;
    font-size: 18px;
    color: #495057;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 8px;
}

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f8f9fa;
}

.metric-row:last-child {
    border-bottom: none;
}

.metric-label {
    font-weight: 500;
    color: #495057;
}

.metric-value {
    font-weight: 600;
    color: #212529;
}

.metric-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-healthy { background-color: #d4edda; color: #155724; }
.status-warning { background-color: #fff3cd; color: #664d03; }
.status-critical { background-color: #f8d7da; color: #721c24; }
.status-unknown { background-color: #e2e3e5; color: #495057; }

.action-section {
    background-color: #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
}

.action-section h3 {
    margin: 0 0 16px 0;
    color: #495057;
}

.action-list {
    margin: 0;
    padding-left: 20px;
}

.action-list li {
    margin: 8px 0;
    color: #495057;
}

.resource-table {
    width: 100%;
    border-collapse: collapse;
    margin: 16px 0;
    font-size: 14px;
}

.resource-table th,
.resource-table td {
    text-align: left;
    padding: 8px 12px;
    border-bottom: 1px solid #e9ecef;
}

.resource-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.resource-table td {
    color: #212529;
}

.progress-bar {
    height: 8px;
    background-color: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin: 4px 0;
}

.progress-fill {
    height: 100%;
    transition: width 0.3s ease;
}

.progress-normal { background-color: #28a745; }
.progress-warning { background-color: #ffc107; }
.progress-danger { background-color: #dc3545; }

.contact-info {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    margin: 20px 0;
    font-size: 14px;
}

.contact-info h4 {
    margin: 0 0 12px 0;
    color: #495057;
}

.contact-link {
    color: #007bff;
    text-decoration: none;
    font-weight: 500;
}

.contact-link:hover {
    text-decoration: underline;
}

/* Responsive adjustments */
@media screen and (max-width: 600px) {
    .metrics-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .alert-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .alert-timestamp {
        margin-top: 8px;
    }
    
    .metric-row {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .metric-value {
        margin-top: 4px;
    }
    
    .resource-table {
        font-size: 12px;
    }
    
    .resource-table th,
    .resource-table td {
        padding: 6px 8px;
    }
}

/* Dark mode adjustments */
@media (prefers-color-scheme: dark) {
    .metrics-card {
        background-color: #2d2d2d !important;
        border-color: #404040 !important;
    }
    
    .metrics-card h3 {
        color: #ffffff !important;
        border-bottom-color: #404040 !important;
    }
    
    .metric-label,
    .metric-value {
        color: #ffffff !important;
    }
    
    .action-section,
    .contact-info {
        background-color: #2d2d2d !important;
    }
    
    .resource-table th {
        background-color: #404040 !important;
        color: #ffffff !important;
    }
    
    .resource-table td {
        color: #ffffff !important;
    }
    
    .progress-bar {
        background-color: #404040 !important;
    }
}
{% endblock %}

{% block email_content %}
<div class="alert-container alert-{{ severity|lower }}">
    <div class="alert-header">
        <h2 class="alert-severity">{{ severity }} Alert</h2>
        <p class="alert-timestamp">{{ timestamp|strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
    </div>
    <h1>{{ alert_type }}: {{ alert_title }}</h1>
    <p><strong>Alert ID:</strong> {{ alert_id }}</p>
    <p><strong>Environment:</strong> {{ environment|upper }}</p>
    <p><strong>Description:</strong> {{ description }}</p>
    {% if alert_details %}
    <p><strong>Details:</strong> {{ alert_details }}</p>
    {% endif %}
</div>

{% if container_metrics %}
<div class="metrics-card">
    <h3>üê≥ Container Health Status</h3>
    
    {% if container_metrics.cluster_info %}
    <div class="metric-row">
        <span class="metric-label">Orchestration Platform:</span>
        <span class="metric-value">{{ container_metrics.cluster_info.platform }} ({{ container_metrics.cluster_info.cluster_name }})</span>
    </div>
    <div class="metric-row">
        <span class="metric-label">Cluster Status:</span>
        <span class="metric-status status-{{ container_metrics.cluster_info.status|lower }}">{{ container_metrics.cluster_info.status }}</span>
    </div>
    {% endif %}
    
    <table class="resource-table">
        <thead>
            <tr>
                <th>Container Instance</th>
                <th>Status</th>
                <th>CPU Usage</th>
                <th>Memory Usage</th>
                <th>Uptime</th>
            </tr>
        </thead>
        <tbody>
            {% for container in container_metrics.containers %}
            <tr>
                <td>{{ container.name }}</td>
                <td><span class="metric-status status-{{ container.status|lower }}">{{ container.status }}</span></td>
                <td>
                    {{ container.cpu_usage }}%
                    <div class="progress-bar">
                        <div class="progress-fill progress-{% if container.cpu_usage > 80 %}danger{% elif container.cpu_usage > 60 %}warning{% else %}normal{% endif %}" 
                             style="width: {{ container.cpu_usage }}%"></div>
                    </div>
                </td>
                <td>
                    {{ container.memory_usage }}%
                    <div class="progress-bar">
                        <div class="progress-fill progress-{% if container.memory_usage > 80 %}danger{% elif container.memory_usage > 60 %}warning{% else %}normal{% endif %}" 
                             style="width: {{ container.memory_usage }}%"></div>
                    </div>
                </td>
                <td>{{ container.uptime }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if container_metrics.network_io %}
    <div class="metric-row">
        <span class="metric-label">Network I/O:</span>
        <span class="metric-value">{{ container_metrics.network_io.rx_bytes }} / {{ container_metrics.network_io.tx_bytes }}</span>
    </div>
    {% endif %}
</div>
{% endif %}

{% if wsgi_metrics %}
<div class="metrics-card">
    <h3>‚öôÔ∏è WSGI Server Performance</h3>
    
    <div class="metric-row">
        <span class="metric-label">Gunicorn Master Process:</span>
        <span class="metric-status status-{{ wsgi_metrics.master_status|lower }}">{{ wsgi_metrics.master_status }}</span>
    </div>
    
    <table class="resource-table">
        <thead>
            <tr>
                <th>Worker ID</th>
                <th>Status</th>
                <th>Requests Handled</th>
                <th>Memory Usage</th>
                <th>Last Activity</th>
            </tr>
        </thead>
        <tbody>
            {% for worker in wsgi_metrics.workers %}
            <tr>
                <td>{{ worker.id }}</td>
                <td><span class="metric-status status-{{ worker.status|lower }}">{{ worker.status }}</span></td>
                <td>{{ worker.requests_handled }}</td>
                <td>{{ worker.memory_usage }} MB</td>
                <td>{{ worker.last_activity }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div class="metric-row">
        <span class="metric-label">Request Queue Depth:</span>
        <span class="metric-value">{{ wsgi_metrics.queue_depth }}</span>
    </div>
    <div class="metric-row">
        <span class="metric-label">Average Response Time:</span>
        <span class="metric-value">{{ wsgi_metrics.avg_response_time }}ms</span>
    </div>
    <div class="metric-row">
        <span class="metric-label">Worker Restart Count (24h):</span>
        <span class="metric-value">{{ wsgi_metrics.restart_count }}</span>
    </div>
</div>
{% endif %}

{% if database_metrics %}
<div class="metrics-card">
    <h3>üíæ Database Connectivity</h3>
    
    <div class="metric-row">
        <span class="metric-label">Database Status:</span>
        <span class="metric-status status-{{ database_metrics.status|lower }}">{{ database_metrics.status }}</span>
    </div>
    <div class="metric-row">
        <span class="metric-label">Connection Pool Status:</span>
        <span class="metric-value">{{ database_metrics.pool.active_connections }}/{{ database_metrics.pool.max_connections }} active</span>
    </div>
    <div class="metric-row">
        <span class="metric-label">Pool Utilization:</span>
        <span class="metric-value">
            {{ database_metrics.pool.utilization }}%
            <div class="progress-bar">
                <div class="progress-fill progress-{% if database_metrics.pool.utilization > 90 %}danger{% elif database_metrics.pool.utilization > 70 %}warning{% else %}normal{% endif %}" 
                     style="width: {{ database_metrics.pool.utilization }}%"></div>
            </div>
        </span>
    </div>
    <div class="metric-row">
        <span class="metric-label">Average Query Time:</span>
        <span class="metric-value">{{ database_metrics.avg_query_time }}ms</span>
    </div>
    <div class="metric-row">
        <span class="metric-label">Failed Connections (1h):</span>
        <span class="metric-value">{{ database_metrics.failed_connections }}</span>
    </div>
    {% if database_metrics.slow_queries %}
    <div class="metric-row">
        <span class="metric-label">Slow Queries (>100ms):</span>
        <span class="metric-value">{{ database_metrics.slow_queries }} queries</span>
    </div>
    {% endif %}
</div>
{% endif %}

{% if aws_metrics %}
<div class="metrics-card">
    <h3>‚òÅÔ∏è AWS Infrastructure Health</h3>
    
    {% if aws_metrics.cloudwatch %}
    <div class="metric-row">
        <span class="metric-label">CloudWatch Container Insights:</span>
        <span class="metric-status status-{{ aws_metrics.cloudwatch.status|lower }}">{{ aws_metrics.cloudwatch.status }}</span>
    </div>
    {% endif %}
    
    {% if aws_metrics.ecs %}
    <div class="metric-row">
        <span class="metric-label">ECS Service Status:</span>
        <span class="metric-value">{{ aws_metrics.ecs.running_tasks }}/{{ aws_metrics.ecs.desired_tasks }} tasks running</span>
    </div>
    <div class="metric-row">
        <span class="metric-label">ECS Cluster Utilization:</span>
        <span class="metric-value">{{ aws_metrics.ecs.cpu_utilization }}% CPU, {{ aws_metrics.ecs.memory_utilization }}% Memory</span>
    </div>
    {% endif %}
    
    {% if aws_metrics.eks %}
    <div class="metric-row">
        <span class="metric-label">EKS Cluster Status:</span>
        <span class="metric-status status-{{ aws_metrics.eks.status|lower }}">{{ aws_metrics.eks.status }}</span>
    </div>
    <div class="metric-row">
        <span class="metric-label">Pod Status:</span>
        <span class="metric-value">{{ aws_metrics.eks.running_pods }}/{{ aws_metrics.eks.desired_pods }} pods running</span>
    </div>
    {% endif %}
    
    {% if aws_metrics.rds %}
    <div class="metric-row">
        <span class="metric-label">RDS Instance Status:</span>
        <span class="metric-status status-{{ aws_metrics.rds.status|lower }}">{{ aws_metrics.rds.status }}</span>
    </div>
    <div class="metric-row">
        <span class="metric-label">RDS CPU Utilization:</span>
        <span class="metric-value">{{ aws_metrics.rds.cpu_utilization }}%</span>
    </div>
    {% endif %}
    
    {% if aws_metrics.load_balancer %}
    <div class="metric-row">
        <span class="metric-label">Load Balancer Health:</span>
        <span class="metric-value">{{ aws_metrics.load_balancer.healthy_targets }}/{{ aws_metrics.load_balancer.total_targets }} targets healthy</span>
    </div>
    {% endif %}
</div>
{% endif %}

{% if system_metrics %}
<div class="metrics-card">
    <h3>üìä System Resource Utilization</h3>
    
    <div class="metric-row">
        <span class="metric-label">Overall System CPU:</span>
        <span class="metric-value">
            {{ system_metrics.cpu_usage }}%
            <div class="progress-bar">
                <div class="progress-fill progress-{% if system_metrics.cpu_usage > 80 %}danger{% elif system_metrics.cpu_usage > 60 %}warning{% else %}normal{% endif %}" 
                     style="width: {{ system_metrics.cpu_usage }}%"></div>
            </div>
        </span>
    </div>
    <div class="metric-row">
        <span class="metric-label">System Memory Usage:</span>
        <span class="metric-value">
            {{ system_metrics.memory_usage }}%
            <div class="progress-bar">
                <div class="progress-fill progress-{% if system_metrics.memory_usage > 80 %}danger{% elif system_metrics.memory_usage > 60 %}warning{% else %}normal{% endif %}" 
                     style="width: {{ system_metrics.memory_usage }}%"></div>
            </div>
        </span>
    </div>
    <div class="metric-row">
        <span class="metric-label">Disk I/O:</span>
        <span class="metric-value">{{ system_metrics.disk_io.read_ops }}/{{ system_metrics.disk_io.write_ops }} ops/sec</span>
    </div>
    <div class="metric-row">
        <span class="metric-label">Network Traffic:</span>
        <span class="metric-value">{{ system_metrics.network.rx_mbps }} Mbps in / {{ system_metrics.network.tx_mbps }} Mbps out</span>
    </div>
</div>
{% endif %}

<div class="action-section">
    <h3>üö® Immediate Actions Required</h3>
    <ul class="action-list">
        {% if recommended_actions %}
            {% for action in recommended_actions %}
            <li>{{ action }}</li>
            {% endfor %}
        {% else %}
        <li>Review infrastructure metrics and determine appropriate response</li>
        <li>Check container orchestration platform for service health</li>
        <li>Validate WSGI server worker processes and request handling</li>
        <li>Monitor database connection pool and query performance</li>
        <li>Verify AWS service health and resource utilization</li>
        {% endif %}
    </ul>
</div>

{% if runbook_links %}
<div class="action-section">
    <h3>üìñ Operations Runbooks</h3>
    <ul class="action-list">
        {% for runbook in runbook_links %}
        <li><a href="{{ runbook.url }}" class="contact-link">{{ runbook.title }}</a></li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="contact-info">
    <h4>üÜò Emergency Contacts</h4>
    <p><strong>Operations Team:</strong> <a href="mailto:{{ ops_team_email|default('ops@company.com') }}" class="contact-link">{{ ops_team_email|default('ops@company.com') }}</a></p>
    <p><strong>Infrastructure Team:</strong> <a href="mailto:{{ infra_team_email|default('infrastructure@company.com') }}" class="contact-link">{{ infra_team_email|default('infrastructure@company.com') }}</a></p>
    <p><strong>On-Call Engineer:</strong> <a href="tel:{{ oncall_phone|default('+1-800-ON-CALL') }}" class="contact-link">{{ oncall_phone|default('+1-800-ON-CALL') }}</a></p>
    {% if slack_channel %}
    <p><strong>Slack Channel:</strong> <a href="{{ slack_channel.url }}" class="contact-link">{{ slack_channel.name }}</a></p>
    {% endif %}
    {% if dashboard_url %}
    <p><strong>Monitoring Dashboard:</strong> <a href="{{ dashboard_url }}" class="contact-link">View Real-time Metrics</a></p>
    {% endif %}
</div>

<div class="alert-container alert-{{ severity|lower }}">
    <p><strong>Alert Generated:</strong> {{ timestamp|strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
    <p><strong>Monitoring System:</strong> Flask Application Infrastructure Monitor</p>
    <p><strong>Next Check:</strong> {{ next_check|strftime('%Y-%m-%d %H:%M:%S UTC') if next_check else 'Continuous monitoring active' }}</p>
</div>
{% endblock %}

{% block footer_content %}
<p>Flask Infrastructure Monitoring System</p>
<p>
    <a href="{{ monitoring_dashboard_url|default('#') }}">Monitoring Dashboard</a> |
    <a href="{{ runbook_url|default('#') }}">Operations Runbooks</a> |
    <a href="{{ escalation_url|default('#') }}">Escalation Procedures</a>
</p>
<p>This is an automated infrastructure alert from the Flask application monitoring system.</p>
{% endblock %}